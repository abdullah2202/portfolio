name: Website CI

on:
  pull_request:
    branches: [dev, main]
    paths:
      - "website/**"
      - ".github/workflows/ci-website.yml"

jobs:
  website-checks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check required files exist
        run: |
          test -f website/index.html
          test -f website/projects.json
          echo "Required files exist."

      - name: Validate projects.json
        run: |
          python - << 'PY'
          import json, sys, pathlib
          p = pathlib.Path("website/projects.json")
          data = json.loads(p.read_text(encoding="utf-8"))
          if not isinstance(data, list):
            print("projects.json must be a JSON array (list).")
            sys.exit(1)
          for i, item in enumerate(data):
            if not isinstance(item, dict):
              print(f"Item {i} must be an object.")
              sys.exit(1)
            for key in ("name","description","github"):
              if key not in item or not isinstance(item[key], str) or not item[key].strip():
                print(f"Item {i} missing/invalid '{key}' (must be a non-empty string).")
                sys.exit(1)
          print(f"projects.json OK ({len(data)} projects).")
          PY

      # Optional: basic HTML lint via Node + htmlhint
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install htmlhint
        run: npm i -g htmlhint@latest

      - name: HTMLHint (index.html)
        run: htmlhint website/index.html

      # Optional: prevent accidental large files
      - name: Check for large files in website/
        run: |
          python - << 'PY'
          import os
          root = "website"
          limit_mb = 5
          bad = []
          for dp, _, fn in os.walk(root):
            for f in fn:
              p = os.path.join(dp, f)
              size = os.path.getsize(p)
              if size > limit_mb * 1024 * 1024:
                bad.append((p, size))
          if bad:
            for p, s in bad:
              print(f"File too large: {p} ({s/1024/1024:.2f} MB) > {limit_mb} MB")
            raise SystemExit(1)
          print("No large files found.")
          PY
